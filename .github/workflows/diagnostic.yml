name: ç³»ç»Ÿè¯Šæ–­ (System Diagnostic)

on:
  workflow_dispatch:
    inputs:
      diagnostic_reason:
        description: "è¯Šæ–­åŸå› "
        required: true
        default: "ä¾‹è¡Œæ£€æŸ¥"
      diagnostic_level:
        description: "è¯Šæ–­çº§åˆ«"
        required: true
        default: "basic"
        type: choice
        options:
          - basic
          - advanced
          - emergency

jobs:
  diagnostic:
    name: ç³»ç»Ÿè¯Šæ–­
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“‹ æ˜¾ç¤ºè¯Šæ–­ä¿¡æ¯
        run: |
          echo "è¯Šæ–­åŸå› : ${{ inputs.diagnostic_reason }}"
          echo "è¯Šæ–­çº§åˆ«: ${{ inputs.diagnostic_level }}"
          echo "è¿è¡ŒID: ${{ github.run_id }}"
          echo "è§¦å‘äº‹ä»¶: ${{ github.event_name }}"

      - name: ğŸ” æ£€æŸ¥ç¯å¢ƒ
        run: |
          echo "æ“ä½œç³»ç»Ÿä¿¡æ¯:"
          uname -a
          cat /etc/os-release

          echo "ç£ç›˜ç©ºé—´:"
          df -h

          echo "å†…å­˜ä½¿ç”¨æƒ…å†µ:"
          free -h

          echo "CPUä¿¡æ¯:"
          cat /proc/cpuinfo | grep "model name" | head -n 1

      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ”§ æ£€æŸ¥Node.jså’ŒYarn
        run: |
          echo "Node.jsç‰ˆæœ¬:"
          node -v

          echo "Yarnç‰ˆæœ¬:"
          yarn -v || echo "Yarnæœªå®‰è£…"

          echo "æ£€æŸ¥Yarnæ˜¯å¦å­˜åœ¨:"
          which yarn || echo "æ‰¾ä¸åˆ°yarnå‘½ä»¤"

          echo "æ£€æŸ¥npmæ˜¯å¦å­˜åœ¨:"
          which npm || echo "æ‰¾ä¸åˆ°npmå‘½ä»¤"

      - name: ğŸ“‹ æ£€æŸ¥å·¥ä½œæµæ–‡ä»¶
        run: |
          echo "æŸ¥æ‰¾æ‰€æœ‰å·¥ä½œæµæ–‡ä»¶:"
          find . -name "*.yml" | grep -i workflow

          echo "æ£€æŸ¥.github/workflowsç›®å½•:"
          ls -la .github/workflows/

          echo "æ£€æŸ¥å½“å‰åˆ†æ”¯å’Œæäº¤:"
          git branch
          git log -1

      - name: ğŸ§ª åˆ›å»ºåŸºæœ¬æµ‹è¯•
        run: |
          # åˆ›å»ºä¸€ä¸ªç®€å•çš„æµ‹è¯•æ–‡ä»¶
          mkdir -p diagnostic-test
          cd diagnostic-test
          echo 'console.log("è¯Šæ–­æµ‹è¯•è¿è¡Œä¸­"); console.log("å½“å‰æ—¶é—´:", new Date().toISOString()); process.exit(0);' > diagnostic-test.js

          # è¿è¡Œæµ‹è¯•
          node diagnostic-test.js
          echo "âœ… åŸºæœ¬è¯Šæ–­æµ‹è¯•é€šè¿‡"

      - name: ğŸ“¦ è®¾ç½® Node.js
        if: inputs.diagnostic_level != 'basic'
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "yarn"

      - name: ğŸ§¹ æ¸…é™¤ç¼“å­˜
        if: inputs.diagnostic_level != 'basic'
        run: |
          echo "æ¸…é™¤ç¼“å­˜..."
          rm -rf node_modules || true
          rm -rf backend/node_modules || true
          rm -rf frontend/node_modules || true
          rm -rf ~/.yarn/cache || true
          yarn cache clean || true
          echo "âœ… ç¼“å­˜å·²æ¸…é™¤"

      - name: ğŸ“¥ å®‰è£…åç«¯ä¾èµ–
        if: inputs.diagnostic_level == 'advanced' || inputs.diagnostic_level == 'emergency'
        working-directory: ./backend
        run: yarn install --network-timeout 300000

      - name: ğŸ“¥ å®‰è£…å‰ç«¯ä¾èµ–
        if: inputs.diagnostic_level == 'advanced' || inputs.diagnostic_level == 'emergency'
        working-directory: ./frontend
        run: yarn install

      - name: ğŸ”§ æ£€æŸ¥ Babel é…ç½®
        if: inputs.diagnostic_level == 'advanced' || inputs.diagnostic_level == 'emergency'
        run: |
          cd backend
          echo "=== backendç›®å½•ä¸­çš„BabelåŒ…æ£€æŸ¥ ==="
          find node_modules -name "@babel" -type d | sort || echo "æ‰¾ä¸åˆ°@babelç›®å½•"
          find node_modules -name "babel-*" | sort || echo "æ‰¾ä¸åˆ°babel-*åŒ…"

          echo "=== æ£€æŸ¥babelé…ç½®æ–‡ä»¶ ==="
          if [ -f "babel.config.js" ]; then
            echo "babel.config.jså­˜åœ¨:"
            cat babel.config.js
          else
            echo "babel.config.jsä¸å­˜åœ¨ï¼Œåˆ›å»ºé»˜è®¤é…ç½®:"
            echo 'module.exports = {
              presets: [
                ["@babel/preset-env", { targets: { node: "current" }, modules: "commonjs" }]
              ],
              plugins: [
                "@babel/plugin-transform-modules-commonjs"
              ],
              sourceType: "unambiguous"
            };' > babel.config.js
            echo "å·²åˆ›å»ºbabel.config.js"
          fi

      - name: ğŸ§ª è¿è¡Œç´§æ€¥æµ‹è¯•
        if: inputs.diagnostic_level == 'emergency'
        run: |
          # åˆ›å»ºä¸€ä¸ªç´§æ€¥æµ‹è¯•æ–‡ä»¶
          echo 'console.log("ç´§æ€¥è¯Šæ–­æµ‹è¯•è¿è¡Œä¸­"); console.log("å½“å‰æ—¶é—´:", new Date().toISOString()); process.exit(0);' > emergency-test.js

          # è¿è¡Œæµ‹è¯•
          node emergency-test.js
          echo "âœ… ç´§æ€¥è¯Šæ–­æµ‹è¯•é€šè¿‡"

          # åˆ›å»ºè™šæ‹Ÿbabelæ–‡ä»¶
          echo 'module.exports = { plugins: [] };' > babel-virtual-resolve-base.js
          echo "âœ… è™šæ‹Ÿæ–‡ä»¶åˆ›å»ºæˆåŠŸ"

      - name: ğŸ“Š è·å– GitHub Actions è¿è¡Œå†å²
        if: inputs.diagnostic_level == 'advanced' || inputs.diagnostic_level == 'emergency'
        run: |
          echo "=== æœ€è¿‘çš„ GitHub Actions è¿è¡Œå†å² ==="
          curl -H "Accept: application/vnd.github.v3+json" \
               -H "Authorization: token ${{ github.token }}" \
               "https://api.github.com/repos/${{ github.repository }}/actions/runs?per_page=5" | \
          jq '.workflow_runs[] | {id, name, workflow_id, event, status, conclusion, created_at}'

          echo "=== æ‰€æœ‰å·¥ä½œæµå®šä¹‰ ==="
          curl -H "Accept: application/vnd.github.v3+json" \
               -H "Authorization: token ${{ github.token }}" \
               "https://api.github.com/repos/${{ github.repository }}/actions/workflows" | \
          jq '.workflows[] | {id, name, path, state}'
