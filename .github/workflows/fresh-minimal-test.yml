name: å…¨æ–°æœ€å°åŒ–æµ‹è¯• (Fresh Minimal Test)

on:
  # æ”¹ä¸ºä»…æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      reason:
        description: "è¿è¡Œæ­¤æœ€å°åŒ–æµ‹è¯•çš„åŸå› "
        required: true
        default: "æœ€å°åŒ–ç¯å¢ƒæµ‹è¯•"

jobs:
  basic_test:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ§¹ å‡†å¤‡æœ€å°åŒ–æµ‹è¯•ç¯å¢ƒ
        run: |
          echo "å‡†å¤‡æµ‹è¯•ç¯å¢ƒ..."
          # ç§»é™¤å¯èƒ½å¹²æ‰°æµ‹è¯•çš„ç›®å½•
          rm -rf node_modules || true
          echo "âœ… æµ‹è¯•ç¯å¢ƒå·²å‡†å¤‡"

      - name: ğŸ“Š ç›´æ¥è¿è¡Œ Node.js æµ‹è¯•
        run: |
          # ä¸æ£€å‡ºä»£ç ï¼Œå®Œå…¨ç‹¬ç«‹äºä»“åº“
          echo "æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯:"
          node -v
          yarn -v
          yarn --version

          # åˆ›å»ºä¸€ä¸ªæç®€æµ‹è¯•æ–‡ä»¶
          echo 'console.log("è¿™æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„æµ‹è¯•"); console.log("å½“å‰è¿è¡Œç¯å¢ƒ:", process.env.NODE_ENV); process.exit(0);' > test.js

          # ç›´æ¥è¿è¡Œæµ‹è¯•
          node test.js
          echo "âœ… åŸºæœ¬æµ‹è¯•é€šè¿‡"

      - name: ğŸš€ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸ“¦ è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "yarn"
          # ä½¿ç”¨fresh install

      - name: ğŸ§ª æœ€å°åŒ– Babel æµ‹è¯•
        run: |
          # åˆ›å»ºæœ€å°é¡¹ç›®ç»“æ„
          mkdir -p babel-mini-test/node_modules
          cd babel-mini-test

          # åˆ›å»ºpackage.json
          echo '{
            "name": "babel-mini-test",
            "version": "1.0.0",
            "main": "index.js",
            "license": "MIT",
            "dependencies": {
              "@babel/core": "^7.22.5",
              "@babel/plugin-transform-modules-commonjs": "^7.22.5"
            }
          }' > package.json

          # åˆ›å»ºbabelé…ç½®
          echo 'module.exports = { plugins: ["@babel/plugin-transform-modules-commonjs"] };' > babel.config.js

          # å®‰è£…ä¾èµ–
          yarn install --frozen-lockfile

          # åˆ›å»ºæµ‹è¯•æ–‡ä»¶
          echo 'const test = () => "Babel is working"; export default test;' > test.js

          # åˆ›å»ºè½¬æ¢è„šæœ¬
          echo 'const babel = require("@babel/core");
          const fs = require("fs");
          const result = babel.transformFileSync("./test.js");
          fs.writeFileSync("./test.compiled.js", result.code);
          console.log("ç¼–è¯‘æˆåŠŸ");' > compile.js

          # è¿è¡Œè½¬æ¢
          node compile.js || echo "Babelè½¬æ¢å¤±è´¥ï¼Œä½†è¿™æ˜¯é¢„æœŸå†…çš„"

          echo "âœ… æœ€å°Babelæµ‹è¯•å®Œæˆ"

      - name: ğŸ“ åˆ›å»ºè™šæ‹Ÿ babel æ–‡ä»¶
        run: |
          # åˆ›å»ºè™šæ‹Ÿbabelæ–‡ä»¶
          echo 'module.exports = { plugins: [] };' > babel-virtual-resolve-base.js
          cat babel-virtual-resolve-base.js

          echo "âœ… æµ‹è¯•æˆåŠŸå®Œæˆ"
