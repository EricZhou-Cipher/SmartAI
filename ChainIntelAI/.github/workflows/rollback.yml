name: è‡ªåŠ¨å›æ»š
on:
  repository_dispatch:
    types: [rollback]

jobs:
  rollback:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
        with:
          fetch-depth: 0 # è·å–å®Œæ•´å†å²ä»¥ä¾¿å›æ»š

      - name: è·å–å›æ»šä¿¡æ¯
        id: rollback-info
        run: |
          echo "trigger=${{ github.event.client_payload.trigger }}" >> $GITHUB_OUTPUT
          echo "p95_latency=${{ github.event.client_payload.p95Latency }}" >> $GITHUB_OUTPUT
          echo "error_rate=${{ github.event.client_payload.errorRate }}" >> $GITHUB_OUTPUT
          echo "timestamp=${{ github.event.client_payload.timestamp }}" >> $GITHUB_OUTPUT

      - name: åˆ›å»ºå›æ»šåˆ†æ”¯
        id: create-branch
        run: |
          ROLLBACK_BRANCH="rollback-$(date +%s)"
          git checkout -b $ROLLBACK_BRANCH
          echo "branch=$ROLLBACK_BRANCH" >> $GITHUB_OUTPUT

      - name: å›æ»šåˆ°ä¸Šä¸€ä¸ªç¨³å®šç‰ˆæœ¬
        run: |
          # è·å–æœ€è¿‘çš„æäº¤
          COMMITS=$(git log --pretty=format:"%H %s" -n 10)

          # æŸ¥æ‰¾æœ€è¿‘çš„ç¨³å®šç‰ˆæœ¬ï¼ˆæ ‡è®°ä¸º[stable]çš„æäº¤ï¼‰
          STABLE_COMMIT=""
          while IFS= read -r line; do
            COMMIT=$(echo $line | cut -d' ' -f1)
            MESSAGE=$(echo $line | cut -d' ' -f2-)
            
            if [[ "$MESSAGE" == *"[stable]"* ]]; then
              STABLE_COMMIT=$COMMIT
              break
            fi
          done <<< "$COMMITS"

          # å¦‚æœæ‰¾åˆ°ç¨³å®šç‰ˆæœ¬ï¼Œå›æ»šåˆ°è¯¥ç‰ˆæœ¬
          if [ -n "$STABLE_COMMIT" ]; then
            echo "æ‰¾åˆ°ç¨³å®šç‰ˆæœ¬: $STABLE_COMMIT"
            git reset --hard $STABLE_COMMIT
          else
            # å¦åˆ™ï¼Œå›æ»šåˆ°ä¸Šä¸€ä¸ªæäº¤
            echo "æœªæ‰¾åˆ°ç¨³å®šç‰ˆæœ¬ï¼Œå›æ»šåˆ°ä¸Šä¸€ä¸ªæäº¤"
            git reset --hard HEAD~1
          fi

      - name: æ¨é€å›æ»šåˆ†æ”¯
        run: |
          git push origin ${{ steps.create-branch.outputs.branch }}

      - name: åˆ›å»ºå›æ»šPR
        uses: peter-evans/create-pull-request@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: "ğŸ”„ è‡ªåŠ¨å›æ»š - æ€§èƒ½æ¶åŒ–"
          body: |
            # è‡ªåŠ¨å›æ»š

            ç”±äºæ£€æµ‹åˆ°æ€§èƒ½ä¸¥é‡æ¶åŒ–ï¼Œç³»ç»Ÿè‡ªåŠ¨è§¦å‘äº†å›æ»šæ“ä½œã€‚

            ## å›æ»šä¿¡æ¯

            - **è§¦å‘åŸå› **: ${{ steps.rollback-info.outputs.trigger }}
            - **P95å»¶è¿Ÿ**: ${{ steps.rollback-info.outputs.p95_latency }} ms
            - **é”™è¯¯ç‡**: ${{ steps.rollback-info.outputs.error_rate }}%
            - **æ—¶é—´**: ${{ steps.rollback-info.outputs.timestamp }}

            è¯·å®¡æ ¸æ­¤PRå¹¶åˆå¹¶ä»¥å®Œæˆå›æ»šï¼Œæˆ–è€…å…³é—­æ­¤PRå¹¶æ‰‹åŠ¨è§£å†³æ€§èƒ½é—®é¢˜ã€‚
          branch: ${{ steps.create-branch.outputs.branch }}
          base: main
          labels: "rollback,performance"

      - name: Slacké€šçŸ¥
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          fields: repo,message,commit,author,action,eventName,ref,workflow
          custom_payload: |
            {
              "attachments": [
                {
                  "color": "danger",
                  "title": "ğŸ”„ è‡ªåŠ¨å›æ»šå·²è§¦å‘",
                  "fields": [
                    {
                      "title": "è§¦å‘åŸå› ",
                      "value": "${{ steps.rollback-info.outputs.trigger }}",
                      "short": true
                    },
                    {
                      "title": "P95å»¶è¿Ÿ",
                      "value": "${{ steps.rollback-info.outputs.p95_latency }} ms",
                      "short": true
                    },
                    {
                      "title": "é”™è¯¯ç‡",
                      "value": "${{ steps.rollback-info.outputs.error_rate }}%",
                      "short": true
                    },
                    {
                      "title": "å›æ»šåˆ†æ”¯",
                      "value": "${{ steps.create-branch.outputs.branch }}",
                      "short": true
                    }
                  ],
                  "footer": "ChainIntelAI è‡ªåŠ¨å›æ»šç³»ç»Ÿ",
                  "footer_icon": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
                  "ts": ${{ github.event.client_payload.timestamp ? github.event.client_payload.timestamp : github.event.repository.updated_at }}
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  deploy-rollback:
    needs: rollback
    runs-on: ubuntu-latest
    if: ${{ github.event.client_payload.trigger == 'critical' }}
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v3
        with:
          ref: ${{ needs.rollback.outputs.branch }}

      - name: è®¾ç½®Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 16
          cache: "yarn"

      - name: å®‰è£…ä¾èµ–
        run: |
          cd backend
          yarn install --frozen-lockfile

      - name: æ„å»ºåº”ç”¨
        run: |
          cd backend
          yarn build

      - name: éƒ¨ç½²å›æ»šç‰ˆæœ¬
        run: |
          cd backend
          # è¿™é‡Œå¯ä»¥æ·»åŠ éƒ¨ç½²å‘½ä»¤ï¼Œä¾‹å¦‚ï¼š
          # - å¤åˆ¶æ–‡ä»¶åˆ°æœåŠ¡å™¨
          # - é‡å¯æœåŠ¡
          # - æ›´æ–°Kuberneteséƒ¨ç½²
          echo "éƒ¨ç½²å›æ»šç‰ˆæœ¬..."

          # ç¤ºä¾‹ï¼šå¦‚æœä½¿ç”¨SSHéƒ¨ç½²
          # scp -r dist/* user@server:/path/to/app

          # ç¤ºä¾‹ï¼šå¦‚æœä½¿ç”¨Kubernetes
          # kubectl apply -f k8s/deployment.yaml
